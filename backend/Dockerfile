# 1. ë¹Œë“œ ë‹¨ê³„ (Node 20)
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

# ğŸ” ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ npm ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
RUN npm install -g npm@latest

# ëª¨ë“  íŒŒì¼ ë³µì‚¬
COPY . .

# ê¸€ë¡œë²Œ íˆ´ ì„¤ì¹˜ (Nest CLI ë“±)
RUN npm install -g @nestjs/cli @types/node

# ğŸ‘‡ schemas í´ë”ê°€ ìˆë‹¤ë©´, ì•±ì˜ src í´ë” ì•ˆìœ¼ë¡œ ë³µì‚¬
RUN [ -d "schemas" ] && cp -r schemas ${APP_NAME}/src/ || true

# --- MSA ë¹Œë“œ ì‹¤í–‰ ---
RUN cd ${APP_NAME} && \
    npm install && \
    ln -s /app/${APP_NAME}/node_modules /app/node_modules && \
    nest build

# 2. ì‹¤í–‰ ë‹¨ê³„ (ìµœì¢… ì´ë¯¸ì§€)
FROM node:20-alpine AS runner
ARG APP_NAME

WORKDIR /app
ENV NODE_ENV=production

# ëŸ°íƒ€ì„ íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/${APP_NAME}/dist ./dist
COPY --from=builder /app/${APP_NAME}/package.json ./package.json

# í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ì„¤ì¹˜ í›„, npm(ë° ë‚´ë¶€ ì·¨ì•½ ë¼ì´ë¸ŒëŸ¬ë¦¬) ì œê±°
RUN npm install --production && \
    rm -rf /usr/local/lib/node_modules/npm

EXPOSE 3000-4000

# main.js ìë™ íƒìƒ‰í•´ì„œ ì‹¤í–‰
CMD ["sh", "-c", "node $(find dist -name main.js | head -n 1)"]

