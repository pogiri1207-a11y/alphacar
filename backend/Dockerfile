# 1. ë¹Œë“œ ë‹¨ê³„ (Node 20)
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

COPY package*.json ./
RUN npm install
RUN npm install -g @nestjs/cli

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [í•µì‹¬ ìˆ˜ì •] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ğŸ‘‡ğŸ‘‡ğŸ‘‡
# Node.jsì—ê²Œ node_modulesê°€ ìˆëŠ” ìƒìœ„ í´ë”ë¥¼ ëª¨ë“ˆ ê²€ìƒ‰ ê²½ë¡œì— ì¶”ê°€í•˜ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤.
ENV NODE_PATH=./node_modules/:../node_modules

COPY . .

# ê¸°ì¡´ cd ëª…ë ¹ì–´ ìœ ì§€
RUN cd ${APP_NAME} && nest build

# 2. ì‹¤í–‰ ë‹¨ê³„
FROM node:20-alpine
ARG APP_NAME

WORKDIR /app
COPY package*.json ./
RUN npm install --production

# ëŸ°íƒ€ì„ í™˜ê²½ì—ë„ NODE_PATH ì„¤ì • ìœ ì§€
ENV NODE_PATH=./node_modules/:../node_modules

COPY --from=builder /app/${APP_NAME}/dist ./dist

EXPOSE 3000-4000
CMD ["node", "dist/main"]
