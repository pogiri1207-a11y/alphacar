# 1. ë¹Œë“œ ë‹¨ê³„ (Node 20)
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

COPY package*.json ./
RUN npm install
RUN npm install -g @nestjs/cli

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [í•µì‹¬ ìˆ˜ì •] COPY . . ëª…ë ¹ì„ ì•ìœ¼ë¡œ ë‹¹ê²¼ìŠµë‹ˆë‹¤! ğŸ‘‡ğŸ‘‡ğŸ‘‡
COPY . .

# 1. ê° ì•±ì´ ìƒìœ„ node_modulesë¥¼ ì°¾ë„ë¡ ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ìƒì„± (ì´ì œ aichat í´ë”ê°€ ì¡´ì¬í•¨)
RUN ln -s /app/node_modules /app/${APP_NAME}/node_modules
# 2. ì „ì—­ íƒ€ì… ì„¤ì¹˜ (Buffer, process íƒ€ì… ì—ëŸ¬ í•´ê²°)
RUN npm install -g @types/node

# ì•± í´ë”ë¡œ ì´ë™ í›„ ë¹Œë“œ
RUN cd ${APP_NAME} && nest build

# 2. ì‹¤í–‰ ë‹¨ê³„ (ì—¬ê¸°ëŠ” ë™ì¼)
FROM node:20-alpine
ARG APP_NAME

WORKDIR /app
COPY package*.json ./
RUN npm install --production

COPY --from=builder /app/${APP_NAME}/dist ./dist

EXPOSE 3000-4000
CMD ["node", "dist/main"]
