# 1. ë¹Œë“œ ë‹¨ê³„ (Node 20)
FROM node:20-alpine AS builder
ARG APP_NAME

WORKDIR /app

COPY package*.json ./
RUN npm install
RUN npm install -g @nestjs/cli

COPY . .

# 1. ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± (íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œ í•´ê²°)
RUN ln -s /app/node_modules /app/${APP_NAME}/node_modules
# 2. ì „ì—­ íƒ€ì… ì„¤ì¹˜ (Buffer, process ì—ëŸ¬ í•´ê²°)
RUN npm install -g @types/node

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ [ìµœì¢… ìˆ˜ì •] ëª¨ë“ˆ ê²€ìƒ‰ ê²½ë¡œ ë¬¸ì œ í•´ê²° ğŸ‘‡ğŸ‘‡ğŸ‘‡
# 3. í•´ë‹¹ ì•±ì˜ tsconfig.jsonì„ ë³µì‚¬ (ì‚¬ì‹¤ìƒ COPY . .ì— í¬í•¨ë¨)
# 4. tsconfig.json ë‚´ë¶€ì— baseUrl ì„¤ì •ì„ ì£¼ì…í•˜ì—¬ ëª¨ë“ˆ ê²€ìƒ‰ ê²½ë¡œë¥¼ ìƒìœ„ë¡œ ë³€ê²½
RUN sed -i 's/"rootDir": "src",/"rootDir": "src",\n    "baseUrl": "..",/g' ${APP_NAME}/tsconfig.json

# ì•± í´ë”ë¡œ ì´ë™ í›„ ë¹Œë“œ
RUN cd ${APP_NAME} && nest build

# 2. ì‹¤í–‰ ë‹¨ê³„
FROM node:20-alpine
ARG APP_NAME

WORKDIR /app
COPY package*.json ./
RUN npm install --production

# ë¹Œë“œ ê²°ê³¼ë¬¼ ê°€ì ¸ì˜¤ê¸°
COPY --from=builder /app/${APP_NAME}/dist ./dist

EXPOSE 3000-4000
CMD ["node", "dist/main"]
