pipeline {
    agent any

    environment {
        // ì„±ê³µí–ˆë˜ í•˜ë²„ ì„¤ì •
        HARBOR_URL = '192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        IMAGE_NAME = 'frontend'
        CREDENTIAL_ID = 'harbor-cred'
        SONARQUBE = 'sonarqube'
    }

    stages {
        stage('Prepare') {
            steps {
                script {
                    // í”„ë¡ íŠ¸ì—”ë“œ ë²„ì „ ì •ë³´ ì½ê¸° (íŒŒì¼ì´ ì—†ë‹¤ë©´ '1.0' ê¸°ë³¸ê°’ ì‚¬ìš©)
                    def baseVer = "1.0"
                    try {
                        baseVer = readFile('frontend/version.txt').trim()
                    } catch (e) {
                        echo "âš ï¸ version.txtë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ê°’(1.0)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
                    }
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}"
                    echo "ğŸš€ Frontend Version: ${env.FULL_VERSION}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner'
                    // credentialsIdëŠ” ì  í‚¨ìŠ¤ì— ë“±ë¡í•œ ì†Œë‚˜íë¸Œ í† í°ì˜ IDë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: sonarqube-token)
                    withSonarQubeEnv(installationName: "${SONARQUBE}") {
                        // í”„ë¡ íŠ¸ì—”ë“œ í´ë”ë§Œ ì •ë°€ ìŠ¤ìº”
                        sh "${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=alphacar-frontend \
                        -Dsonar.sources=frontend \
                        -Dsonar.host.url=http://192.168.56.200:32001"
                    }
                }
            }
        }

        stage('Docker Build') {
            steps {
                echo "ğŸ”¨ Next.js ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
                // í”„ë¡ íŠ¸ì—”ë“œ í´ë” ë‚´ì˜ Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ
                sh "docker build -f frontend/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION} frontend/"
            }
        }

        stage('Harbor Push') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: "${CREDENTIAL_ID}", passwordVariable: 'HUB_PASS', usernameVariable: 'HUB_USER')]) {
                        sh "echo ${HUB_PASS} | docker login ${HARBOR_URL} -u ${HUB_USER} --password-stdin"
                        sh "docker push ${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
                        sh "docker logout ${HARBOR_URL}"
                    }
                }
            }
        }

        stage('Cleanup') {
            steps {
                // ë¹Œë“œ ì™„ë£Œ í›„ ë¡œì»¬ ì´ë¯¸ì§€ ì‚­ì œí•˜ì—¬ ìš©ëŸ‰ í™•ë³´
                sh "docker rmi ${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
            }
        }
    }

    post {
        success {
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ! í•˜ë²„ì—ì„œ ${env.FULL_VERSION} íƒœê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
        failure {
            echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”."
        }
    }
}
