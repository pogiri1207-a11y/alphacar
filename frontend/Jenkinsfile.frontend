pipeline {
    agent any

    environment {
        // í•˜ë²„ ë° ì†Œë‚˜íë¸Œ ì„¤ì •
        HARBOR_URL = '192.168.56.200:30002'
        HARBOR_PROJECT = 'alphacar'
        IMAGE_NAME = 'frontend'
        CREDENTIAL_ID = 'harbor-cred'
        SONAR_TOKEN_ID = 'sonarqube-token'
    }

    stages {
        stage('Prepare') {
            steps {
                script {
                    def baseVer = "1.0"
                    try {
                        baseVer = readFile('frontend/version.txt').trim()
                    } catch (e) {
                        echo "âš ï¸ version.txt ì—†ìŒ, ê¸°ë³¸ê°’(1.0) ì‚¬ìš©"
                    }
                    env.FULL_VERSION = "${baseVer}.${currentBuild.number}"
                    echo "ğŸš€ ë¹Œë“œ ë²„ì „: ${env.FULL_VERSION}"
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner'
                    withCredentials([string(credentialsId: "${SONAR_TOKEN_ID}", variable: 'S_TOKEN')]) {
                        // ğŸš€ [ì†ë„ ê°œì„ ] node_modules, .next í´ë”ë¥¼ ìŠ¤ìº”ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.
                        sh """
                        ${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=alphacar-frontend \
                        -Dsonar.sources=frontend \
                        -Dsonar.host.url=http://192.168.56.200:32001 \
                        -Dsonar.login=${S_TOKEN} \
                        -Dsonar.exclusions=**/node_modules/**,**/.next/**,**/dist/**,**/out/**
                        """
                    }
                }
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    // ğŸš€ [ì—ëŸ¬ í•´ê²°] ìë™ ì„¤ì¹˜ëœ ë„ì»¤ì˜ ê²½ë¡œë¥¼ ì •í™•íˆ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    def dockerHome = tool 'docker'
                    echo "ğŸ”¨ Next.js ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
                    // 'docker' ëª…ë ¹ì–´ ì•ì— ê²½ë¡œ(${dockerHome}/bin/)ë¥¼ í™•ì‹¤íˆ ë¶™ì—¬ì¤ë‹ˆë‹¤.
                    sh "${dockerHome}/bin/docker build -f frontend/Dockerfile -t ${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION} frontend/"
                }
            }
        }

        stage('Harbor Push') {
            steps {
                script {
                    def dockerHome = tool 'docker'
                    withCredentials([usernamePassword(credentialsId: "${CREDENTIAL_ID}", passwordVariable: 'HUB_PASS', usernameVariable: 'HUB_USER')]) {
                        sh "echo ${HUB_PASS} | ${dockerHome}/bin/docker login ${HARBOR_URL} -u ${HUB_USER} --password-stdin"
                        sh "${dockerHome}/bin/docker push ${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
                        sh "${dockerHome}/bin/docker logout ${HARBOR_URL}"
                    }
                }
            }
        }

        stage('Cleanup') {
            steps {
                script {
                    def dockerHome = tool 'docker'
                    // ë¹Œë“œ í›„ ë¡œì»¬ ì´ë¯¸ì§€ ì‚­ì œí•˜ì—¬ ì„œë²„ ìš©ëŸ‰ í™•ë³´
                    sh "${dockerHome}/bin/docker rmi ${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}:${env.FULL_VERSION}"
                }
            }
        }
    }

    post {
        success {
            echo "âœ… ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ë‹¨ê³„(ì†Œë‚˜íë¸Œ+ë„ì»¤)ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤."
        }
        failure {
            echo "âŒ ë¹Œë“œ ì¤‘ ì—ëŸ¬ ë°œìƒ! ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}
